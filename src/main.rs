use chrono::Duration;
use env_logger::Env;
use log::{debug, error, info};

use crate::{phtheirichthys::{BoatOptions, Phtheirichthys}, race::Race};
use crate::position::BoatStatus;
use crate::router::RouteRequest;
use crate::utils::Speed;
use crate::wind::Wind;


pub(crate) mod algorithm;
pub(crate) mod land;
pub mod phtheirichthys;
pub(crate) mod polar;
pub mod position;
pub(crate) mod race;
mod router;
mod utils;
pub mod wind;
mod tests;

#[cfg(feature = "tokio")]
#[tokio::main]
async fn main() {

    std::env::var("RUST_LOG").map_err(|_| {
        std::env::set_var("RUST_LOG", "error,phtheirichthys=debug");
    }).unwrap_or_default();
    env_logger::init();

    debug!("Testing Phtheirichthys ...");

    let phtheirichthys = Phtheirichthys::new();

    phtheirichthys.add_wind_provider().await;
    phtheirichthys.add_land_provider().await;

    while phtheirichthys.get_wind_provider_status("vr".to_string()).is_err() {
        tokio::time::sleep(std::time::Duration::from_secs(3)).await;
    }

    let status = phtheirichthys.get_wind_provider_status("vr".to_string()).unwrap();

    debug!("Status : {:?}", status.current_ref_time);

    debug!("Start Phtheirichthys");

    let polar = r#"
    {
        "_id":19,"label":"multi/mod70","globalSpeedRatio":1,"iceSpeedRatio":0.3,"autoSailChangeTolerance":1.014,"badSailTolerance":1.02,"maxSpeed":32.72,"foil":{"speedRatio":1.04,"twaMin":80,"twaMax":160,"twaMerge":10,"twsMin":16,"twsMax":35,"twsMerge":5},"hull":{"speedRatio":1.003},"winch":{"tack":{"stdTimerSec":300,"stdRatio":0.5,"proTimerSec":75,"proRatio":0.5,"std":{"lw":{"ratio":0.5,"timer":180},"hw":{"ratio":0.5,"timer":300}},"pro":{"lw":{"ratio":0.7,"timer":180},"hw":{"ratio":0.7,"timer":300}}},"gybe":{"stdTimerSec":300,"stdRatio":0.5,"proTimerSec":75,"proRatio":0.5,"std":{"lw":{"ratio":0.5,"timer":240},"hw":{"ratio":0.5,"timer":300}},"pro":{"lw":{"ratio":0.7,"timer":240},"hw":{"ratio":0.7,"timer":300}}},"sailChange":{"stdTimerSec":300,"stdRatio":0.5,"proTimerSec":75,"proRatio":0.5,"std":{"lw":{"ratio":0.5,"timer":300},"hw":{"ratio":0.5,"timer":360}},"pro":{"lw":{"ratio":0.7,"timer":300},"hw":{"ratio":0.7,"timer":360}}},"lws":10,"hws":30},"tws":[0,4,6,8,10,12,14,16,20,25,30,40,70],"twa":[0,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180],"sail":[{"id":1,"name":"Jib","speed":[[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,1.73,2.52,4,4.55,5.86,7.09,8.12,9.26,8.37,7.32,1.7,0],[0,2.57,3.65,5.68,6.75,8.34,10.1,11.72,13.57,12.36,10.66,2.53,0],[0,3.39,4.79,7.34,8.83,10.79,13.05,15,17.49,16.09,13.77,3.34,0],[0,4.16,6.08,9.12,10.85,13.39,16.2,18.14,20.73,19.46,17.1,4.1,0],[0,4.9,7.18,10.13,12.64,14.95,18.38,20.55,23.45,22.56,19.85,4.82,0],[0,5.42,7.72,10.68,13.62,16.08,19.82,22.33,24.65,25.47,22.88,5.44,0],[0,5.78,8.27,11.31,14.73,17.59,21.58,24.34,25.86,28.03,25.71,5.76,0],[0,5.82,8.65,11.88,15.88,19.3,23.48,26.04,26.81,29.61,27.9,5.86,0],[0,5.77,8.73,12.24,16.53,20.45,25.04,26.92,27.33,30.58,29.66,5.98,0],[0,5.37,8.35,12.01,16.58,21.14,25.95,27.76,27.76,31.45,30.57,5.95,0],[0,4.67,7.5,11,15.27,20.21,24.99,27.81,28.18,31.74,29.99,5.61,0],[0,3.42,5.86,8.81,12.11,16.69,21.63,25.51,29.16,31.65,29.46,5.03,0],[0,2.41,3.93,6.13,8.68,12.4,16.79,20.8,27.4,29.63,28.68,4.52,0],[0,1.58,2.52,4.08,5.97,8.74,12.1,15.37,21.87,25.42,25.7,3.94,0],[0,0.97,1.52,2.57,3.98,5.89,8.29,10.77,15.73,19.17,20.48,3.2,0],[0,0.54,0.84,1.51,2.52,3.73,5.29,7.02,10.38,13.35,15.19,2.45,0],[0,0.27,0.41,0.8,1.49,2.18,3.06,4.15,6.16,8.47,10.41,1.72,0]]},{"id":2,"name":"Spi","speed":[[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0.01,0,0,0,0,0,0,0,0,0,0,0],[0,0.09,0.07,0.04,0.02,0.01,0,0,0,0,0,0,0],[0,0.42,0.36,0.32,0.19,0.11,0.05,0.01,0,0,0,0,0],[0,1.19,1.24,1.25,0.94,0.67,0.43,0.22,0.05,0,0,0,0],[0,2.52,2.92,3.12,2.81,2.27,1.79,1.19,0.47,0.12,0.01,0,0],[0,4.11,5.04,5.79,5.9,5.34,4.81,3.76,2.01,0.85,0.24,0,0],[0,5.44,7.22,8.86,10.02,10.02,9.93,8.67,5.53,3.22,1.34,0.03,0],[0,5.82,8.58,11.35,14.16,15.58,16.59,15.57,11.3,8.07,4.37,0.18,0],[0,5.95,8.83,12.25,16.47,19.77,22.78,22.34,18.25,15.24,10.04,0.66,0],[0,5.98,8.93,12.45,16.83,21.19,25.92,27.12,24.51,23.37,17.66,1.57,0],[0,5.92,8.92,12.42,16.49,21.11,25.47,27.95,28.02,29.6,24.39,2.73,0],[0,5.18,8.15,11.36,14.63,19.06,23.6,26.84,29.54,31.65,28.56,3.69,0],[0,4.59,6.72,9.51,12.32,16.29,20.59,24.07,29.47,30.43,28.77,4.19,0],[0,4,5.58,8,10.49,13.87,17.55,20.55,26.23,28.15,26.89,3.94,0],[0,3.41,4.61,6.73,9.09,11.89,14.94,17.51,22.12,24.06,23.47,3.28,0],[0,2.82,3.68,5.56,7.9,10.11,12.49,14.62,17.99,19.96,20.05,2.7,0],[0,2.23,2.72,4.37,6.79,8.34,9.99,11.64,13.87,15.87,16.63,2.14,0]]},{"id":3,"name":"Staysail","speed":[[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0.63,1.13,2.11,2.77,4.05,5.47,6.93,9.41,8.63,7.55,1.75,0],[0,0.94,1.63,3,4.11,5.76,7.79,9.99,13.78,12.74,10.99,2.61,0],[0,1.24,2.14,3.88,5.38,7.45,10.07,12.79,17.76,16.59,14.2,3.44,0],[0,1.52,2.72,4.81,6.61,9.24,12.5,15.47,21.05,20.06,17.63,4.23,0],[0,1.79,3.21,5.35,7.7,10.32,14.19,17.53,23.82,23.26,20.46,4.97,0],[0,1.97,3.43,5.61,8.27,11.06,15.23,18.97,24.93,26.26,23.59,5.61,0],[0,1.96,3.42,5.53,8.31,11.24,15.41,19.21,24.3,28.9,26.5,5.94,0],[0,1.74,3.16,5.14,7.92,10.9,14.83,18.19,22.28,30.21,28.76,6.04,0],[0,1.5,2.72,4.46,6.94,9.73,13.31,15.82,19.12,29.56,30.58,6.17,0],[0,1.21,2.2,3.62,5.65,8.06,11.03,13.04,15.52,27.22,31.28,6.13,0],[0,0.89,1.63,2.69,4.12,6.01,8.22,9.96,11.9,23.41,30.1,5.78,0],[0,0.56,1.07,1.77,2.63,3.88,5.37,6.75,8.84,18.85,27,5.19,0],[0,0.34,0.6,1.01,1.5,2.26,3.19,4.12,6.01,13.84,22.7,4.66,0],[0,0.19,0.32,0.55,0.83,1.24,1.76,2.27,3.45,9.33,17.3,4.06,0],[0,0.1,0.16,0.28,0.44,0.65,0.91,1.18,1.78,5.51,11.45,3.38,0],[0,0.05,0.08,0.14,0.22,0.32,0.44,0.57,0.84,2.99,7.23,2.78,0],[0,0.02,0.03,0.06,0.11,0.15,0.2,0.25,0.36,1.47,4.2,2.21,0]]},{"id":4,"name":"LightJib","speed":[[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,1.78,2.6,4.12,4.69,6.04,7.31,8.37,9.55,7.01,3.81,0.04,0],[0,2.65,3.76,5.86,6.96,8.6,10.41,12.08,13.99,10.34,6.4,0.14,0],[0,3.49,4.94,7.57,9.1,11.12,13.45,15.46,18.03,13.47,8.65,0.31,0],[0,4.29,6.27,9.4,11.19,13.8,16.7,18.7,21.37,16.3,10.74,0.56,0],[0,5.05,7.4,10.44,13.03,15.41,18.95,21.19,24.18,18.89,12.46,0.84,0],[0,5.55,7.92,10.96,13.98,16.51,20.35,22.92,25.41,21.33,14.37,1.09,0],[0,5.53,7.89,10.79,14.06,16.78,20.59,23.22,24.73,23.33,16.14,1.22,0],[0,5,7.3,10.03,13.4,16.3,19.82,21.98,22.62,23.71,17.52,1.22,0],[0,4.23,6.27,8.7,11.74,14.52,17.78,19.12,19.41,22.21,18.18,1.25,0],[0,3.4,5.07,7.07,9.55,12.04,14.73,15.76,15.76,19.7,17.52,1.26,0],[0,2.5,3.77,5.24,6.96,8.97,10.98,12.04,12.08,16.31,15.3,1.22,0],[0,1.57,2.48,3.45,4.44,5.79,7.17,8.16,8.97,12.63,12.68,1.04,0],[0,0.95,1.39,1.97,2.54,3.37,4.26,4.98,6.1,8.91,9.75,0.86,0],[0,0.53,0.75,1.07,1.4,1.85,2.34,2.75,3.5,5.77,6.92,0.66,0],[0,0.28,0.38,0.55,0.74,0.97,1.22,1.43,1.81,3.27,4.34,0.48,0],[0,0.13,0.17,0.26,0.37,0.48,0.59,0.69,0.85,1.7,2.53,0.31,0],[0,0.06,0.07,0.12,0.18,0.22,0.26,0.31,0.37,0.81,1.35,0.19,0]]},{"id":5,"name":"Code0","speed":[[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0.46,0.67,1.07,1.21,1.56,1.89,2.16,2.47,0.38,0.01,0,0],[0,1.27,1.8,2.8,3.32,4.11,4.97,5.77,6.68,1.77,0.15,0,0],[0,2.51,3.55,5.44,6.53,7.98,9.66,11.1,12.95,5.16,0.87,0,0],[0,3.89,5.69,8.53,10.16,12.53,15.16,16.98,18.6,10.91,3.07,0,0],[0,4.8,7.25,10.23,12.77,15.1,18.57,20.77,22.66,18.17,7.43,0.02,0],[0,5.59,7.96,11.01,14.04,16.58,20.43,23.02,25.32,24.9,14.21,0.17,0],[0,5.96,8.53,11.66,15.19,18.13,22.25,25.09,26.66,28.61,21.94,0.63,0],[0,6,8.92,12.25,16.37,19.9,24.21,26.85,27.64,30.53,27.79,2.13,0],[0,6.13,9.1,12.63,17.04,21.08,25.81,27.75,28.18,31.53,30.12,3.83,0],[0,6.17,9.21,12.84,17.35,21.85,26.75,28.62,28.62,32.42,31.52,4.9,0],[0,5.86,8.97,12.53,16.66,21.46,26.26,28.81,29.05,32.72,30.92,5.51,0],[0,4.84,7.75,10.98,14.33,18.89,23.58,26.98,29.84,32.54,30.37,5.17,0],[0,3.77,5.68,8.28,10.96,14.91,19.24,22.9,27.96,30.3,29.21,4.59,0],[0,2.71,3.95,5.91,8.04,11.03,14.42,17.42,23.45,26.42,26.48,3.94,0],[0,1.8,2.57,3.96,5.62,7.71,10.14,12.41,16.97,20.28,21.1,3.25,0],[0,1.08,1.51,2.44,3.69,5.02,6.58,8.14,11.12,13.99,15.45,2.45,0],[0,0.58,0.77,1.34,2.25,2.97,3.83,4.78,6.48,8.69,10.33,1.66,0]]},{"id":6,"name":"HeavyGnk","speed":[[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0.03,0.03,0.03,0.02,0.02,0.01,0,0,0.5,0,0,0],[0,0.13,0.19,0.23,0.22,0.18,0.14,0.09,0.02,1,0,0,0],[0,0.41,0.67,0.9,1.04,1.01,0.94,0.75,0.32,4,2,0.01,0],[0,0.81,1.54,2.31,3.08,3.45,3.65,3.31,1.9,9,6,0.2,0],[0,1.17,2.43,4.07,6.06,7.7,9.13,9.03,11,16,12,1,0],[0,1.24,2.78,5.13,8.39,11.95,15.64,17.02,19,24,19,2.1,0],[0,1.2,2.72,5.04,8.37,12.94,18.45,22.61,26,30,26,3.5,0],[0,1.05,2.48,4.61,7.43,11.61,16.78,21.8,29.99,32.63,29.68,4.38,0],[0,0.93,2.04,3.86,6.23,9.92,14.64,19.55,29.92,31.37,29.66,4.51,0],[0,0.81,1.7,3.25,5.32,8.45,12.47,16.7,26.63,29.02,27.72,3.94,0],[0,0.69,1.4,2.73,4.61,7.25,10.62,14.22,22.46,24.8,24.2,3.3,0],[0,0.57,1.12,2.26,4.01,6.16,8.88,11.88,18.27,20.58,20.67,2.7,0],[0,0.45,0.83,1.77,3.45,5.08,7.1,9.46,14.09,16.36,17.14,2.15,0]]},{"id":7,"name":"LightGnk","speed":[[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0.02,0.02,0.01,0.01,0,0,0,0,0,0,0],[0,1,0.21,0.2,0.17,0.13,0.1,0.07,0.03,0,0,0,0],[0,3,3,3,3,0.95,0.84,0.67,0.33,0.09,0.02,0,0],[0,5,6,7,8,7,8,6,3,0.81,0.23,0,0],[0,5.6,8,10.5,14,15,17,15,13,6,1.4,0.02,0],[0,6.11,8.9,12.1,16.68,20,24,23,20,15,4.97,0.13,0],[0,6.1,9.2,12.8,17,21.76,26.15,27.83,26.7,23,11.09,0.43,0],[0,5.34,8.4,11.71,15.08,19.65,24.33,27.67,30.45,26.5,17.46,1.1,0],[0,4.73,6.93,9.8,12.7,16.79,21.23,24.81,30.38,26.28,19.57,1.46,0],[0,4.12,5.75,8.25,10.81,14.3,18.09,21.19,27.04,24.3,18.29,1.48,0],[0,3.52,4.75,6.94,9.37,12.26,15.4,18.05,22.8,20.77,15.97,1.3,0],[0,2.91,3.79,5.73,8.14,10.42,12.88,15.07,18.55,17.23,13.64,1.11,0],[0,2.3,2.8,4.5,7,8.6,10.3,12,14.3,13.7,11.31,0.93,0]]}],"_updatedAt":"2024-01-30T18:13:04.998Z"
    }"#;

    let polar = serde_json::from_str(polar).expect("polar ok");

    phtheirichthys.add_polar("19".to_string(), polar);

    let race = r#"
    {
        "id":"snowflake",
        "leg":1,
        "name":"Snowflake California Offshore Race Week #1",
        "shortName":"Snowflake #1",
        "boat":"19",
        "start_time":"2023-05-25T19:00:00Z",
        "end_time":"2023-05-27T20:00:00Z",
        "start":{"lat":37.7928,"lon":-122.5332},
        "buoys":[{"type":"Zone","name":"end","radius":10,"destination":{"lat":36.67833,"lon":-121.8874},"to_avoid":[],"validated":false}],
        "ice_limits":{"north":[],"south":[{"lat":-90,"lon":-180},{"lat":-90,"lon":-90},{"lat":-90,"lon":0},{"lat":-90,"lon":90},{"lat":-90,"lon":180}],"maxLat":90,"minLat":-90}
    }"#;

    let race = serde_json::from_str(race).expect("race ok");


    let boat_options = BoatOptions {
        lt: false,
        gt: false,
        code0: false,
        foil: false,
        hull: false,
        winch: false,
        stamina: true,
    };

    let request = RouteRequest {
        from: Default::default(),
        start_time: Default::default(),
        boat_settings: Default::default(),
        status: BoatStatus {
            aground: false,
            boat_speed: Speed::from_kts(0f64),
            wind: Wind { direction: 0.0, speed: Default::default() },
            foil: 0,
            boost: 0,
            best_ratio: 0.0,
            ratio: 0,
            vmgs: None,
            penalties: Default::default(),
            stamina: 0.0,
        },
        steps: vec![
            // (Duration::minutes(30), Duration::minutes(1)),
            // (Duration::hours(1),    Duration::minutes(5)),
            (Duration::hours(3),    Duration::minutes(10)),
            (Duration::hours(12),   Duration::minutes(30)),
            (Duration::hours(24),   Duration::hours(1)),
            (Duration::hours(144),  Duration::hours(3)),
            (Duration::hours(9999), Duration::hours(6)),
        ],
    };

    match phtheirichthys.navigate("vr".to_string(), "19".to_string(), race, boat_options, request).await {
        Ok(_) => info!("Ok"),
        Err(err) => error!("Navigate error : {}", err)
    }

}